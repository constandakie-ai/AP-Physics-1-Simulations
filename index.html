<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AP Physics 1 Simulation Lab</title>
    <style>
        /* --- GLOBAL VARIABLES & RESET --- */
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --bg: #f8f9fa;
            --card-bg: #ffffff;
            --text: #333;
        }
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; min-height: 100vh; }

        /* --- TYPOGRAPHY FOR PHYSICS --- */
        .var { font-style: italic; font-family: 'Times New Roman', serif; }
        .unit { font-family: sans-serif; font-style: normal; font-size: 0.9em; color: #555; }
        sub { font-size: 0.7em; }

        /* --- NAVIGATION --- */
        nav { background: var(--primary); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .nav-brand { font-size: 1.4rem; font-weight: bold; }
        .back-btn { background: rgba(255,255,255,0.15); border: none; color: white; padding: 8px 16px; border-radius: 4px; cursor: pointer; display: none; font-size: 0.9rem; transition: background 0.2s; }
        .back-btn:hover { background: rgba(255,255,255,0.3); }

        /* --- VIEWS CONTAINER --- */
        .view-container { flex: 1; padding: 20px; display: flex; flex-direction: column; align-items: center; width: 100%; max-width: 1200px; margin: 0 auto; }
        .hidden { display: none !important; }

        /* --- MENU GRID --- */
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; width: 100%; margin-top: 20px; }
        .card { background: var(--card-bg); padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; border-left: 6px solid var(--accent); display: flex; flex-direction: column; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .card h2 { margin: 0 0 10px 0; color: var(--primary); }
        .tag { display: inline-block; background: #e3f2fd; color: #1565c0; padding: 4px 10px; border-radius: 15px; font-size: 0.8rem; font-weight: bold; margin-bottom: 10px; width: fit-content; }

        /* --- SIMULATION UI --- */
        .sim-layout { display: flex; flex-wrap: wrap; gap: 20px; width: 100%; justify-content: center; }
        
        /* Sidebar Controls */
        .controls { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); min-width: 280px; flex: 1; max-width: 350px; h-height: fit-content; }
        .control-group { margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .control-group:last-child { border-bottom: none; }
        label { display: flex; justify-content: space-between; margin-bottom: 5px; font-weight: 500; font-size: 0.95rem; }
        input[type=range] { width: 100%; cursor: pointer; }
        
        /* Canvas Area */
        .canvas-wrapper { position: relative; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border: 1px solid #ddd; background: white; }
        canvas { display: block; background: white; cursor: crosshair; }
        
        /* Buttons */
        .btn-row { display: flex; gap: 10px; margin-top: 10px; }
        .btn { flex: 1; padding: 10px; border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer; transition: opacity 0.2s; }
        .btn:hover { opacity: 0.9; }
        .btn-play { background: #27ae60; }
        .btn-reset { background: #c0392b; }
        .btn-step { background: #f39c12; }

        /* --- UNIT 1 TABS --- */
        .tabs { display: flex; gap: 5px; margin-bottom: 20px; overflow-x: auto; width: 100%; padding-bottom: 5px; }
        .tab-btn { padding: 10px 15px; background: #e0e0e0; border: none; border-radius: 4px; cursor: pointer; white-space: nowrap; font-weight: 500; }
        .tab-btn.active { background: var(--primary); color: white; }

        /* --- OVERLAYS --- */
        .overlay-msg { position: absolute; top: 10px; left: 10px; background: rgba(255,255,255,0.9); padding: 5px 10px; border-radius: 4px; pointer-events: none; font-size: 0.8rem; border: 1px solid #ccc; }
    </style>
</head>
<body>

    <!-- === NAVIGATION === -->
    <nav>
        <div class="nav-brand">AP Physics 1 Lab</div>
        <button id="back-btn" class="back-btn" onclick="goHome()">← Back to Menu</button>
    </nav>

    <!-- === MAIN MENU === -->
    <div id="menu-view" class="view-container">
        <h1 style="color: var(--primary);">Select a Unit</h1>
        <p>Interactive simulations aligned with College Board topics.</p>
        
        <div class="grid">
            <!-- Unit 1 -->
            <div class="card" onclick="loadUnit(1)">
                <span class="tag">Unit 1</span>
                <h2>Kinematics</h2>
                <p>1D Motion, Vectors, Graphs, and Projectile Motion with pan/zoom controls.</p>
            </div>
            <!-- Unit 2 -->
            <div class="card" onclick="loadUnit(2)">
                <span class="tag">Unit 2</span>
                <h2>Dynamics</h2>
                <p>Forces, Newton's Laws, and Inclined Planes with Friction.</p>
            </div>
            <!-- Unit 6 -->
            <div class="card" onclick="loadUnit(6)">
                <span class="tag">Unit 6</span>
                <h2>Simple Harmonic Motion</h2>
                <p>Springs, Pendulums, Period, and Frequency.</p>
            </div>
        </div>
    </div>

    <!-- === UNIT 1: KINEMATICS === -->
    <div id="unit1-view" class="view-container hidden">
        <h2>Unit 1: Kinematics</h2>
        
        <!-- Tab Navigation -->
        <div class="tabs">
            <button class="tab-btn active" onclick="u1_switchTab(0)">1.1 Position & Velocity</button>
            <button class="tab-btn" onclick="u1_switchTab(1)">1.2 Graphs</button>
            <button class="tab-btn" onclick="u1_switchTab(2)">1.3 Vectors</button>
            <button class="tab-btn" onclick="u1_switchTab(3)">1.4 Ref Frames</button>
            <button class="tab-btn" onclick="u1_switchTab(4)">1.5 Projectiles</button>
        </div>

        <!-- U1 Sim Container -->
        <div class="sim-layout">
            <div class="controls" id="u1-controls">
                <!-- Controls injected dynamically via JS based on tab -->
            </div>
            
            <div class="canvas-wrapper">
                <canvas id="u1-canvas" width="700" height="450"></canvas>
                <div id="u1-overlay" class="overlay-msg"></div>
            </div>
        </div>
    </div>

    <!-- === UNIT 2: DYNAMICS === -->
    <div id="unit2-view" class="view-container hidden">
        <h2>Unit 2: Dynamics (Inclined Plane)</h2>
        <div class="sim-layout">
            <div class="controls">
                <div class="control-group">
                    <label>Mass (<i class="var">m</i>): <span id="u2-m-val"></span> <span class="unit">kg</span></label>
                    <input type="range" id="u2-m" min="1" max="10" step="0.5" value="2" oninput="u2_update()">
                </div>
                <div class="control-group">
                    <label>Angle (&theta;): <span id="u2-theta-val"></span>&deg;</label>
                    <input type="range" id="u2-theta" min="0" max="60" step="1" value="30" oninput="u2_update()">
                </div>
                <div class="control-group">
                    <label>Coeff. Friction (<i class="var">&mu;</i>): <span id="u2-mu-val"></span></label>
                    <input type="range" id="u2-mu" min="0" max="0.8" step="0.05" value="0.1" oninput="u2_update()">
                </div>
                
                <div style="background: #f0f0f0; padding: 10px; border-radius: 4px; margin-top:10px;">
                    <div>Net Force (<i class="var">F<sub>net</sub></i>): <span id="u2-fnet">0</span> N</div>
                    <div>Accel (<i class="var">a</i>): <span id="u2-acc">0</span> m/s²</div>
                </div>

                <div class="btn-row">
                    <button class="btn btn-play" onclick="u2_toggle()">Play / Pause</button>
                    <button class="btn btn-reset" onclick="u2_reset()">Reset</button>
                </div>
            </div>
            
            <div class="canvas-wrapper">
                <canvas id="u2-canvas" width="700" height="450"></canvas>
            </div>
        </div>
    </div>

    <!-- === UNIT 6: SHM === -->
    <div id="unit6-view" class="view-container hidden">
        <h2>Unit 6: Simple Harmonic Motion</h2>
        <div class="sim-layout">
            <div class="controls">
                <div class="control-group">
                    <label>Mass (<i class="var">m</i>): <span id="u6-m-val"></span> <span class="unit">kg</span></label>
                    <input type="range" id="u6-m" min="0.5" max="5.0" step="0.1" value="1.0" oninput="u6_update()">
                </div>
                <div class="control-group">
                    <label>Spring Constant (<i class="var">k</i>): <span id="u6-k-val"></span> <span class="unit">N/m</span></label>
                    <input type="range" id="u6-k" min="10" max="100" step="5" value="20" oninput="u6_update()">
                </div>
                <div class="control-group">
                    <label>Amplitude (<i class="var">A</i>): <span id="u6-amp-val"></span> <span class="unit">m</span></label>
                    <input type="range" id="u6-amp" min="0.1" max="1.5" step="0.1" value="0.8" oninput="u6_update()">
                </div>
                
                <div style="background: #f0f0f0; padding: 10px; border-radius: 4px;">
                    <div>Period (<i class="var">T</i>): <span id="u6-period"></span> s</div>
                    <div>Freq (<i class="var">f</i>): <span id="u6-freq"></span> Hz</div>
                </div>

                <div class="btn-row">
                    <button class="btn btn-play" onclick="u6_toggle()">Play / Pause</button>
                </div>
            </div>
            
            <div class="canvas-wrapper" style="display:flex; flex-direction: column;">
                <canvas id="u6-canvas" width="600" height="300"></canvas>
                <canvas id="u6-graph" width="600" height="150" style="border-top: 1px solid #ccc;"></canvas>
            </div>
        </div>
    </div>

    <script>
        // === GLOBAL STATE MANAGEMENT ===
        let currentUnit = 0;
        let animationId = null;
        let lastTime = 0;

        // View Switching
        function goHome() {
            stopAll();
            document.querySelectorAll('.view-container').forEach(el => el.classList.add('hidden'));
            document.getElementById('menu-view').classList.remove('hidden');
            document.getElementById('back-btn').style.display = 'none';
        }

        function loadUnit(unit) {
            stopAll();
            currentUnit = unit;
            document.querySelectorAll('.view-container').forEach(el => el.classList.add('hidden'));
            document.getElementById('menu-view').classList.add('hidden');
            document.getElementById('back-btn').style.display = 'block';

            if(unit === 1) {
                document.getElementById('unit1-view').classList.remove('hidden');
                u1_switchTab(0); // Default to first tab
            }
            if(unit === 2) {
                document.getElementById('unit2-view').classList.remove('hidden');
                u2_init();
            }
            if(unit === 6) {
                document.getElementById('unit6-view').classList.remove('hidden');
                u6_init();
            }
        }

        function stopAll() {
            cancelAnimationFrame(animationId);
            animationId = null;
        }

        // =========================================
        // === UNIT 1: KINEMATICS LAB (5 SECTIONS) ===
        // =========================================
        const u1_canvas = document.getElementById('u1-canvas');
        const u1_ctx = u1_canvas.getContext('2d');
        let u1_tab = 0;
        let u1_state = { 
            // Shared State
            t: 0, running: false, 
            // 1.1 & 1.2
            x: 0, v: 0, a: 0,
            // 1.5 Projectile & Camera
            px: 0, py: 0, vx: 0, vy: 0, trail: [],
            camX: 0, camY: 0, scale: 1, isDragging: false, lastMouse: {x:0, y:0}
        };

        // Tab Content Config
        function u1_switchTab(index) {
            stopAll();
            u1_tab = index;
            u1_state.running = false;
            u1_state.t = 0;
            
            // Reset Camera
            u1_state.camX = 0; u1_state.camY = 0; u1_state.scale = 1;

            // Highlight Tab
            document.querySelectorAll('.tab-btn').forEach((b, i) => {
                b.className = i === index ? 'tab-btn active' : 'tab-btn';
            });

            // Inject Controls based on Tab
            const panel = document.getElementById('u1-controls');
            panel.innerHTML = ''; // Clear

            if(index === 0) { // 1D Motion
                u1_state.x = 0; u1_state.v = 10; u1_state.a = 0;
                document.getElementById('u1-overlay').innerText = "Simulating constant acceleration in 1D.";
                panel.innerHTML = `
                    <div class="control-group">
                        <label>Init Velocity (<i class="var">v<sub>i</sub></i>): <span id="u1-v-val">10</span> m/s</label>
                        <input type="range" id="u1-v" min="-20" max="20" value="10" oninput="u1_updateParams()">
                    </div>
                    <div class="control-group">
                        <label>Acceleration (<i class="var">a</i>): <span id="u1-a-val">0</span> m/s²</label>
                        <input type="range" id="u1-a" min="-10" max="10" step="0.5" value="0" oninput="u1_updateParams()">
                    </div>
                    <div class="btn-row"><button class="btn btn-play" onclick="u1_toggle()">Play/Pause</button><button class="btn btn-reset" onclick="u1_reset()">Reset</button></div>
                    <div style="margin-top:10px;">Pos (<i class="var">x</i>): <span id="u1-readout-x">0</span> m</div>
                `;
            } else if (index === 1) { // Graphs
                document.getElementById('u1-overlay').innerText = "Visualize x vs t, v vs t graphs.";
                u1_state.x = 0; u1_state.v = 5; u1_state.a = 0; u1_state.trail = [];
                panel.innerHTML = `
                     <div class="control-group">
                        <label>Velocity (<i class="var">v</i>): <span id="u1-v-val">5</span> m/s</label>
                        <input type="range" id="u1-v" min="-10" max="10" value="5" oninput="u1_updateParams()">
                    </div>
                    <div class="btn-row"><button class="btn btn-play" onclick="u1_toggle()">Play/Pause</button><button class="btn btn-reset" onclick="u1_reset()">Reset</button></div>
                `;
            } else if (index === 2) { // Vectors
                document.getElementById('u1-overlay').innerText = "Drag slider to see components.";
                u1_state.vx = 10; u1_state.vy = 10;
                panel.innerHTML = `
                    <div class="control-group">
                        <label>Magnitude: <span id="u1-mag">14.1</span></label>
                        <input type="range" id="u1-vec-mag" min="0" max="20" value="14.1" oninput="u1_vecUpdate()">
                    </div>
                     <div class="control-group">
                        <label>Angle (&theta;): <span id="u1-vec-ang">45</span>&deg;</label>
                        <input type="range" id="u1-vec-deg" min="0" max="360" value="45" oninput="u1_vecUpdate()">
                    </div>
                `;
            } else if (index === 3) { // Ref Frames
                 document.getElementById('u1-overlay').innerText = "River crossing problem.";
                 u1_state.vx = 4; // Boat speed
                 u1_state.vy = 3; // River speed (acting on y for visualization)
                 panel.innerHTML = `
                    <div class="control-group"><label>Boat Speed: <span id="u1-vb-val">4</span></label><input type="range" id="u1-vb" min="0" max="10" value="4" oninput="u1_rfUpdate()"></div>
                    <div class="control-group"><label>River Speed: <span id="u1-vr-val">3</span></label><input type="range" id="u1-vr" min="0" max="10" value="3" oninput="u1_rfUpdate()"></div>
                    <div class="btn-row"><button class="btn btn-play" onclick="u1_toggle()">Start Crossing</button><button class="btn btn-reset" onclick="u1_reset()">Reset</button></div>
                 `;
            } else if (index === 4) { // Projectile (Complex)
                u1_setupProjectileUI(panel);
                u1_reset(); // Set initial state
            }
            
            u1_draw(); // Initial draw
        }

        // --- U1 Specific Logic ---

        function u1_setupProjectileUI(panel) {
            document.getElementById('u1-overlay').innerText = "Drag to pan. Scroll to zoom. Scrubber for time.";
            panel.innerHTML = `
                <div class="control-group">
                    <label>Init Velocity (<i class="var">v<sub>i</sub></i>): <span id="u1-vi-val">20</span> m/s</label>
                    <input type="range" id="u1-vi" min="1" max="50" value="20" oninput="u1_projUpdate()">
                </div>
                <div class="control-group">
                    <label>Angle (&theta;): <span id="u1-theta-val">45</span>&deg;</label>
                    <input type="range" id="u1-theta" min="0" max="90" value="45" oninput="u1_projUpdate()">
                </div>
                <div class="control-group">
                    <label>Height (&Delta;<i class="var">y</i>): <span id="u1-dy-val">0</span> m</label>
                    <input type="range" id="u1-dy" min="0" max="50" value="0" oninput="u1_projUpdate()">
                </div>
                <div class="control-group">
                     <label>Time Scrubber: <span id="u1-time-val">0.0</span>s</label>
                     <input type="range" id="u1-scrubber" min="0" max="10" step="0.05" value="0" oninput="u1_scrub()">
                </div>
                <div class="btn-row">
                    <button class="btn btn-play" onclick="u1_toggle()">Launch</button>
                    <button class="btn btn-reset" onclick="u1_reset()">Reset</button>
                </div>
            `;
            // Add Mouse Events for Pan/Zoom
            u1_canvas.onmousedown = (e) => { u1_state.isDragging = true; u1_state.lastMouse = {x:e.offsetX, y:e.offsetY}; };
            u1_canvas.onmouseup = () => u1_state.isDragging = false;
            u1_canvas.onmouseout = () => u1_state.isDragging = false;
            u1_canvas.onmousemove = (e) => {
                if(u1_state.isDragging) {
                    u1_state.camX += e.offsetX - u1_state.lastMouse.x;
                    u1_state.camY += e.offsetY - u1_state.lastMouse.y;
                    u1_state.lastMouse = {x:e.offsetX, y:e.offsetY};
                    u1_draw();
                }
            };
            u1_canvas.onwheel = (e) => {
                e.preventDefault();
                const zoomSpeed = 0.001;
                u1_state.scale += -e.deltaY * zoomSpeed * u1_state.scale;
                u1_state.scale = Math.max(0.1, Math.min(u1_state.scale, 5));
                u1_draw();
            };
        }

        function u1_updateParams() {
            if(u1_tab === 0 || u1_tab === 1) {
                u1_state.v = parseFloat(document.getElementById('u1-v').value);
                document.getElementById('u1-v-val').innerText = u1_state.v;
                if(document.getElementById('u1-a')) {
                    u1_state.a = parseFloat(document.getElementById('u1-a').value);
                    document.getElementById('u1-a-val').innerText = u1_state.a;
                }
            }
        }

        function u1_projUpdate() {
            // Just update UI values, don't change physics if running
            document.getElementById('u1-vi-val').innerText = document.getElementById('u1-vi').value;
            document.getElementById('u1-theta-val').innerText = document.getElementById('u1-theta').value;
            document.getElementById('u1-dy-val').innerText = document.getElementById('u1-dy').value;
            if(!u1_state.running) u1_draw();
        }

        function u1_vecUpdate() {
            let m = parseFloat(document.getElementById('u1-vec-mag').value);
            let d = parseFloat(document.getElementById('u1-vec-deg').value);
            document.getElementById('u1-mag').innerText = m;
            document.getElementById('u1-vec-ang').innerText = d;
            u1_draw();
        }

        function u1_rfUpdate() {
            u1_state.vx = parseFloat(document.getElementById('u1-vb').value);
            u1_state.vy = parseFloat(document.getElementById('u1-vr').value);
            document.getElementById('u1-vb-val').innerText = u1_state.vx;
            document.getElementById('u1-vr-val').innerText = u1_state.vy;
        }

        function u1_scrub() {
            u1_state.running = false;
            u1_state.t = parseFloat(document.getElementById('u1-scrubber').value);
            document.getElementById('u1-time-val').innerText = u1_state.t.toFixed(2);
            // Recalculate Px Py based on kinematic eq
            const vi = parseFloat(document.getElementById('u1-vi').value);
            const th = parseFloat(document.getElementById('u1-theta').value) * Math.PI/180;
            const y0 = parseFloat(document.getElementById('u1-dy').value);
            u1_state.px = (vi * Math.cos(th)) * u1_state.t;
            u1_state.py = y0 + (vi * Math.sin(th) * u1_state.t) - (0.5 * 9.8 * u1_state.t*u1_state.t);
            u1_draw();
        }

        function u1_toggle() {
            u1_state.running = !u1_state.running;
            if(u1_state.running) {
                lastTime = performance.now();
                if(u1_tab === 4) {
                    // Initialize projectile physics
                    const vi = parseFloat(document.getElementById('u1-vi').value);
                    const th = parseFloat(document.getElementById('u1-theta').value) * Math.PI/180;
                    const y0 = parseFloat(document.getElementById('u1-dy').value);
                    if(u1_state.t === 0) { // Only reset if at start
                         u1_state.px = 0; u1_state.py = y0;
                         u1_state.vx = vi * Math.cos(th); u1_state.vy = vi * Math.sin(th);
                         u1_state.trail = [];
                    }
                }
                u1_loop();
            }
        }

        function u1_reset() {
            u1_state.running = false;
            u1_state.t = 0;
            u1_state.x = 0;
            if(u1_tab === 4) {
                document.getElementById('u1-scrubber').value = 0;
                document.getElementById('u1-time-val').innerText = "0.0";
                u1_state.trail = [];
                u1_state.py = parseFloat(document.getElementById('u1-dy').value);
                u1_state.px = 0;
            }
            u1_draw();
        }

        function u1_loop(timestamp) {
            if(!u1_state.running) return;
            const dt = 0.02; // Fixed step for stability
            u1_state.t += dt;

            if(u1_tab === 0) { // 1D
                u1_state.v += u1_state.a * dt;
                u1_state.x += u1_state.v * dt;
                document.getElementById('u1-readout-x').innerText = u1_state.x.toFixed(1);
            } else if (u1_tab === 1) { // Graph
                u1_state.x += u1_state.v * dt;
                u1_state.trail.push({t: u1_state.t, x: u1_state.x});
                if(u1_state.trail.length > 200) u1_state.trail.shift();
            } else if (u1_tab === 3) { // RF
                u1_state.x += u1_state.vx * dt; // Across
                u1_state.y = (u1_state.y || 0) + u1_state.vy * dt; // Downstream
            } else if (u1_tab === 4) { // Projectile
                u1_state.px += u1_state.vx * dt;
                u1_state.py += u1_state.vy * dt;
                u1_state.vy -= 9.8 * dt;
                u1_state.trail.push({x: u1_state.px, y: u1_state.py});
                
                // Update Scrubber UI
                document.getElementById('u1-scrubber').value = u1_state.t;
                document.getElementById('u1-time-val').innerText = u1_state.t.toFixed(2);

                if(u1_state.py < 0) { u1_state.py = 0; u1_state.running = false; }
            }

            u1_draw();
            animationId = requestAnimationFrame(u1_loop);
        }

        function u1_draw() {
            u1_ctx.clearRect(0,0,700,450);
            const w = 700, h = 450;
            
            if(u1_tab === 0) { // 1D Car
                u1_ctx.fillStyle = "#ecf0f1"; u1_ctx.fillRect(0, h/2 - 20, w, 40); // Road
                let drawX = (u1_state.x * 10) + 50; // Scale
                drawX = drawX % w; // Wrap
                u1_ctx.fillStyle = "#e74c3c"; u1_ctx.fillRect(drawX, h/2 - 15, 30, 20); // Car
                // Ruler
                u1_ctx.fillStyle = "black";
                for(let i=0; i<w; i+=50) { u1_ctx.fillRect(i, h/2+20, 1, 10); u1_ctx.fillText(i/10 + "m", i-5, h/2+45); }
            } 
            else if (u1_tab === 1) { // Graphs
                // Draw Axes
                u1_ctx.beginPath(); u1_ctx.moveTo(50, 50); u1_ctx.lineTo(50, 400); u1_ctx.lineTo(650, 400); u1_ctx.stroke();
                u1_ctx.fillText("Position (x)", 10, 200); u1_ctx.fillText("Time (t)", 350, 420);
                
                // Plot
                u1_ctx.beginPath(); u1_ctx.strokeStyle = "blue"; u1_ctx.lineWidth = 2;
                u1_state.trail.forEach((p, i) => {
                    let gx = 50 + p.t * 20;
                    let gy = 400 - (p.x * 5); // Scale
                    if(i===0) u1_ctx.moveTo(gx, gy); else u1_ctx.lineTo(gx, gy);
                });
                u1_ctx.stroke();
            }
            else if (u1_tab === 2) { // Vectors
                let m = parseFloat(document.getElementById('u1-vec-mag').value);
                let d = parseFloat(document.getElementById('u1-vec-deg').value);
                let r = d * Math.PI / 180;
                let cx = 350, cy = 225;
                let vx = m * 15 * Math.cos(r);
                let vy = m * 15 * Math.sin(r);

                // Draw Axes
                u1_ctx.strokeStyle = "#ccc"; u1_ctx.beginPath(); u1_ctx.moveTo(cx, 0); u1_ctx.lineTo(cx, 450); u1_ctx.moveTo(0, cy); u1_ctx.lineTo(700, cy); u1_ctx.stroke();
                
                // Main Vector
                u1_arrow(cx, cy, cx+vx, cy-vy, "black");
                // Components
                u1_ctx.setLineDash([5,5]);
                u1_arrow(cx, cy, cx+vx, cy, "red"); // Vx
                u1_arrow(cx+vx, cy, cx+vx, cy-vy, "blue"); // Vy
                u1_ctx.setLineDash([]);
                
                u1_ctx.font = "16px sans-serif";
                u1_ctx.fillStyle = "red"; u1_ctx.fillText(`vx: ${(m*Math.cos(r)).toFixed(1)}`, cx+vx/2, cy+20);
                u1_ctx.fillStyle = "blue"; u1_ctx.fillText(`vy: ${(m*Math.sin(r)).toFixed(1)}`, cx+vx+10, cy-vy/2);
            }
            else if (u1_tab === 3) { // Ref Frames
                // River
                u1_ctx.fillStyle = "#85c1e9"; u1_ctx.fillRect(100, 0, 500, 450);
                u1_ctx.fillStyle = "#2c3e50"; u1_ctx.fillRect(0,0,100,450); u1_ctx.fillRect(600,0,100,450); // Banks
                
                // Boat
                let bx = 100 + (u1_state.x || 0) * 10;
                let by = 225 + (u1_state.y || 0) * 10;
                u1_ctx.fillStyle = "brown"; u1_ctx.beginPath(); u1_ctx.arc(bx, by, 10, 0, Math.PI*2); u1_ctx.fill();
                
                // Vectors
                u1_arrow(bx, by, bx + u1_state.vx*5, by, "white"); // boat velocity
                u1_arrow(bx, by, bx, by + u1_state.vy*5, "blue"); // river velocity
            }
            else if (u1_tab === 4) { // Projectile
                u1_ctx.save();
                
                // Camera Transform
                u1_ctx.translate(u1_state.camX, u1_state.camY);
                u1_ctx.scale(u1_state.scale, u1_state.scale);

                // Grid
                const GRID_SIZE = 50;
                const HEIGHT = 450; // Ground level visually
                
                // Draw Ground
                u1_ctx.fillStyle = "#2ecc71";
                u1_ctx.fillRect(-1000, HEIGHT, 5000, 100);

                // Draw Grid Lines (Dynamic based on viewport would be better, but fixed for simplicity)
                u1_ctx.strokeStyle = "rgba(0,0,0,0.1)";
                u1_ctx.lineWidth = 1;
                u1_ctx.beginPath();
                for(let i=-1000; i<3000; i+=GRID_SIZE) { u1_ctx.moveTo(i, -1000); u1_ctx.lineTo(i, 2000); }
                for(let j=-1000; j<2000; j+=GRID_SIZE) { u1_ctx.moveTo(-1000, j); u1_ctx.lineTo(3000, j); }
                u1_ctx.stroke();

                // Origin Marker
                u1_ctx.fillStyle = "black"; u1_ctx.beginPath(); u1_ctx.arc(0, HEIGHT, 5, 0, Math.PI*2); u1_ctx.fill();

                // Physics to Canvas Mapping (y is up in physics, down in canvas)
                const mapY = (physY) => HEIGHT - (physY * 10); // 10px per meter
                const mapX = (physX) => (physX * 10);

                // Trajectory
                u1_ctx.strokeStyle = "blue";
                u1_ctx.lineWidth = 2;
                u1_ctx.setLineDash([5,5]);
                u1_ctx.beginPath();
                if(u1_state.trail.length > 0) {
                    u1_ctx.moveTo(mapX(u1_state.trail[0].x), mapY(u1_state.trail[0].y));
                    u1_state.trail.forEach(p => u1_ctx.lineTo(mapX(p.x), mapY(p.y)));
                }
                u1_ctx.stroke();
                u1_ctx.setLineDash([]);

                // Ball
                let cx = mapX(u1_state.px);
                let cy = mapY(u1_state.py);
                
                // Preview Ghost if not running
                if(!u1_state.running && u1_state.t === 0) {
                     let y0 = parseFloat(document.getElementById('u1-dy').value);
                     cy = mapY(y0);
                }

                u1_ctx.fillStyle = "red";
                u1_ctx.beginPath(); u1_ctx.arc(cx, cy, 8, 0, Math.PI*2); u1_ctx.fill();
                
                u1_ctx.restore();
            }
        }

        function u1_arrow(x1, y1, x2, y2, color) {
            const headlen = 10;
            const dx = x2 - x1;
            const dy = y2 - y1;
            const angle = Math.atan2(dy, dx);
            u1_ctx.strokeStyle = color; u1_ctx.fillStyle = color; u1_ctx.lineWidth = 2;
            u1_ctx.beginPath(); u1_ctx.moveTo(x1, y1); u1_ctx.lineTo(x2, y2); u1_ctx.stroke();
            u1_ctx.beginPath(); u1_ctx.moveTo(x2, y2);
            u1_ctx.lineTo(x2 - headlen * Math.cos(angle - Math.PI / 6), y2 - headlen * Math.sin(angle - Math.PI / 6));
            u1_ctx.lineTo(x2 - headlen * Math.cos(angle + Math.PI / 6), y2 - headlen * Math.sin(angle + Math.PI / 6));
            u1_ctx.fill();
        }

        // =========================================
        // === UNIT 2: DYNAMICS (Inclined Plane) ===
        // =========================================
        const u2_canvas = document.getElementById('u2-canvas');
        const u2_ctx = u2_canvas.getContext('2d');
        let u2_state = { m: 2, theta: 30, mu: 0.1, x: 0, v: 0, a: 0, t: 0, running: false };

        function u2_init() {
            u2_update(true);
        }

        function u2_update(reset = false) {
            u2_state.m = parseFloat(document.getElementById('u2-m').value);
            u2_state.theta = parseFloat(document.getElementById('u2-theta').value);
            u2_state.mu = parseFloat(document.getElementById('u2-mu').value);
            
            document.getElementById('u2-m-val').innerText = u2_state.m;
            document.getElementById('u2-theta-val').innerText = u2_state.theta;
            document.getElementById('u2-mu-val').innerText = u2_state.mu;

            // Physics Calc
            const rad = u2_state.theta * Math.PI / 180;
            const g = 9.8;
            const Fg_x = u2_state.m * g * Math.sin(rad); // Force down slope
            const Fg_y = u2_state.m * g * Math.cos(rad); // Force into slope
            const Fn = Fg_y; 
            const Ff = u2_state.mu * Fn; // Max static/kinetic friction
            
            let netForce = Fg_x - Ff;
            if(netForce < 0) netForce = 0; // Won't slide up

            u2_state.a = netForce / u2_state.m;

            document.getElementById('u2-fnet').innerText = netForce.toFixed(2);
            document.getElementById('u2-acc').innerText = u2_state.a.toFixed(2);

            if(reset) { u2_state.x = 0; u2_state.v = 0; u2_state.t = 0; u2_state.running = false; }
            
            u2_draw();
        }

        function u2_toggle() {
            u2_state.running = !u2_state.running;
            if(u2_state.running) u2_loop();
        }
        function u2_reset() { u2_update(true); }

        function u2_loop() {
            if(!u2_state.running) return;
            const dt = 0.02;
            u2_state.v += u2_state.a * dt;
            u2_state.x += u2_state.v * dt;
            
            // End of ramp limit
            if(u2_state.x > 8) { u2_state.running = false; } // 8 meters long ramp

            u2_draw();
            animationId = requestAnimationFrame(u2_loop);
        }

        function u2_draw() {
            u2_ctx.clearRect(0,0,700,450);
            
            const cx = 100, cy = 350; // Bottom left of ramp
            const rampLen = 500;
            const angleRad = u2_state.theta * Math.PI / 180;
            
            // Draw Ramp Triangle
            u2_ctx.fillStyle = "#bdc3c7";
            u2_ctx.beginPath();
            u2_ctx.moveTo(cx, cy);
            u2_ctx.lineTo(cx + rampLen * Math.cos(angleRad), cy - rampLen * Math.sin(angleRad)); // Top
            u2_ctx.lineTo(cx + rampLen * Math.cos(angleRad), cy); // Bottom Right
            u2_ctx.fill();

            // Coordinate Transform for Block
            u2_ctx.save();
            u2_ctx.translate(cx, cy);
            u2_ctx.rotate(-angleRad); // Rotate world to match ramp

            // Block Position
            const pixelsPerMeter = 50;
            let bx = u2_state.x * pixelsPerMeter + 50; // Start offset
            
            // Draw Block
            u2_ctx.fillStyle = "#e67e22";
            u2_ctx.fillRect(bx, -40, 40, 40); // Drawn "above" the rotated axis

            // FBD Vectors (Drawn relative to block center)
            const cenX = bx + 20;
            const cenY = -20;
            
            // Normal Force (Up)
            u2_ctx.strokeStyle = "blue"; u2_ctx.lineWidth = 2;
            u2_ctx.beginPath(); u2_ctx.moveTo(cenX, cenY); u2_ctx.lineTo(cenX, cenY - 40); u2_ctx.stroke();
            
            // Friction (Left/Back)
            if(u2_state.mu > 0) {
                u2_ctx.strokeStyle = "red";
                u2_ctx.beginPath(); u2_ctx.moveTo(cenX, cenY); u2_ctx.lineTo(cenX - 30, cenY); u2_ctx.stroke();
            }

            // Restore for Gravity (since gravity is always straight down, not rotated)
            u2_ctx.restore();

            // Draw Gravity Vector (requires world coordinates of block center)
            const worldBx = cx + bx * Math.cos(angleRad) - (-20) * Math.sin(angleRad);
            const worldBy = cy - bx * Math.sin(angleRad) + (-20) * Math.cos(angleRad);
            
            u2_ctx.strokeStyle = "green"; u2_ctx.lineWidth = 2;
            u2_ctx.beginPath(); u2_ctx.moveTo(worldBx, worldBy); u2_ctx.lineTo(worldBx, worldBy + 50); u2_ctx.stroke();
        }


        // =========================================
        // === UNIT 6: SHM (Updated Styling) ===
        // =========================================
        const u6_sCanvas = document.getElementById('u6-canvas');
        const u6_gCanvas = document.getElementById('u6-graph');
        const u6_sCtx = u6_sCanvas.getContext('2d');
        const u6_gCtx = u6_gCanvas.getContext('2d');
        let u6_state = { m: 1, k: 20, A: 0.5, t: 0, running: false, data: [] };

        function u6_init() { u6_update(true); }

        function u6_update(reset = false) {
            u6_state.m = parseFloat(document.getElementById('u6-m').value);
            u6_state.k = parseFloat(document.getElementById('u6-k').value);
            u6_state.A = parseFloat(document.getElementById('u6-amp').value);

            document.getElementById('u6-m-val').innerText = u6_state.m;
            document.getElementById('u6-k-val').innerText = u6_state.k;
            document.getElementById('u6-amp-val').innerText = u6_state.A;

            let T = 2 * Math.PI * Math.sqrt(u6_state.m / u6_state.k);
            document.getElementById('u6-period').innerText = T.toFixed(2);
            document.getElementById('u6-freq').innerText = (1/T).toFixed(2);
            
            if(reset) { u6_state.t = 0; u6_state.data = []; u6_draw(); }
        }

        function u6_toggle() {
            u6_state.running = !u6_state.running;
            if(u6_state.running) u6_loop();
        }

        function u6_loop() {
            if(!u6_state.running) return;
            let w = Math.sqrt(u6_state.k / u6_state.m);
            u6_state.t += 0.04;
            let x = u6_state.A * Math.cos(w * u6_state.t);
            
            u6_state.data.push(x);
            if(u6_state.data.length > 200) u6_state.data.shift();

            u6_draw(x);
            animationId = requestAnimationFrame(u6_loop);
        }

        function u6_draw(x = u6_state.A) {
            // Draw Sim
            u6_sCtx.clearRect(0,0,600,300);
            const center = 300;
            const pxScale = 100;
            let blockX = center + (x * pxScale);
            
            // Wall & Floor
            u6_sCtx.fillStyle = '#95a5a6'; u6_sCtx.fillRect(0, 50, 20, 200); 
            u6_sCtx.beginPath(); u6_sCtx.moveTo(0,250); u6_sCtx.lineTo(600,250); u6_sCtx.stroke();

            // Spring
            u6_sCtx.beginPath(); u6_sCtx.strokeStyle = '#555'; u6_sCtx.moveTo(20, 210);
            for(let i=0; i<=20; i++) {
                let sx = 20 + (i/20) * (blockX - 20);
                u6_sCtx.lineTo(sx, 210 + (i%2==0 ? -10 : 10));
            }
            u6_sCtx.lineTo(blockX, 210); u6_sCtx.stroke();

            // Block
            u6_sCtx.fillStyle = '#3498db'; u6_sCtx.fillRect(blockX, 190, 40, 40);

            // Equilibrium
            u6_sCtx.strokeStyle = 'green'; u6_sCtx.setLineDash([5,5]);
            u6_sCtx.beginPath(); u6_sCtx.moveTo(center+20, 50); u6_sCtx.lineTo(center+20, 250); u6_sCtx.stroke();
            u6_sCtx.setLineDash([]);

            // Draw Graph
            u6_gCtx.clearRect(0,0,600,150);
            u6_gCtx.strokeStyle = '#bdc3c7'; u6_gCtx.beginPath(); u6_gCtx.moveTo(0,75); u6_gCtx.lineTo(600,75); u6_gCtx.stroke();

            u6_gCtx.strokeStyle = '#e74c3c'; u6_gCtx.lineWidth = 2;
            u6_gCtx.beginPath();
            u6_state.data.forEach((val, i) => {
                let px = 600 - (u6_state.data.length - i) * 3;
                let py = 75 - (val * 40);
                if(i===0) u6_gCtx.moveTo(px, py); else u6_gCtx.lineTo(px, py);
            });
            u6_gCtx.stroke();
        }

    </script>
</body>
</html>
