<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AP Physics 1 Complete Simulation Suite</title>
    <style>
        /* --- CORE THEME --- */
        :root {
            --primary: #2c3e50;
            --accent: #2980b9;
            --text: #333;
            --bg: #f4f6f7;
            --panel-bg: #ffffff;
            --math-font: 'Times New Roman', serif;
        }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* --- LAYOUT --- */
        #app-container { display: flex; height: 100%; }
        
        /* SIDEBAR NAVIGATION */
        aside { width: 260px; background: var(--primary); color: white; display: flex; flex-direction: column; overflow-y: auto; flex-shrink: 0; }
        aside h1 { padding: 20px; font-size: 1.2rem; margin: 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .unit-header { padding: 15px 20px; font-weight: bold; background: rgba(0,0,0,0.2); cursor: pointer; display: flex; justify-content: space-between; font-size: 0.9rem; }
        .unit-header:hover { background: rgba(0,0,0,0.3); }
        .sub-menu { display: none; background: #34495e; }
        .sub-menu.open { display: block; }
        .nav-btn { width: 100%; text-align: left; padding: 12px 30px; background: none; border: none; color: #bdc3c7; cursor: pointer; font-size: 0.85rem; transition: 0.2s; border-left: 3px solid transparent; }
        .nav-btn:hover { color: white; background: rgba(255,255,255,0.05); }
        .nav-btn.active { color: white; border-left-color: var(--accent); background: rgba(0,0,0,0.2); }

        /* MAIN CONTENT AREA */
        main { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; }
        
        /* SIMULATION CONTAINER */
        .sim-container { display: flex; gap: 20px; flex-wrap: wrap; align-items: flex-start; }
        .canvas-area { position: relative; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1); background: white; }
        canvas { display: block; cursor: crosshair; }
        
        /* CONTROLS PANEL */
        .controls { background: var(--panel-bg); padding: 20px; border-radius: 8px; width: 300px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); flex-shrink: 0; }
        .control-group { margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        label { display: flex; justify-content: space-between; font-size: 0.9rem; font-weight: 500; margin-bottom: 5px; color: #555; }
        input[type=range] { width: 100%; cursor: pointer; }
        
        /* DESCRIPTION BOX */
        .desc-box { background: white; padding: 20px; border-radius: 8px; border-left: 5px solid var(--accent); line-height: 1.6; color: #444; max-width: 900px; }
        .desc-box h3 { margin-top: 0; color: var(--primary); }

        /* MATH TYPOGRAPHY */
        .var { font-family: var(--math-font); font-style: italic; }
        .unit { font-family: sans-serif; font-style: normal; font-size: 0.85em; color: #7f8c8d; }

        /* UTILITY CLASSES */
        .hidden { display: none !important; }
        .btn { width: 100%; padding: 10px; border: none; border-radius: 4px; color: white; font-weight: bold; cursor: pointer; margin-top: 5px; }
        .btn-green { background: #27ae60; } .btn-green:hover { background: #219150; }
        .btn-red { background: #c0392b; } .btn-red:hover { background: #a93226; }
        
        /* DATA READOUT */
        .readout { font-family: monospace; background: #eee; padding: 10px; border-radius: 4px; margin-top: 10px; font-size: 0.85rem; }

        /* --- THEME VARIATIONS --- */
        /* Space Theme for Unit 3 */
        .theme-space .canvas-area { background: #000; border: 1px solid #333; }
        .theme-space .controls { background: #1a1a1a; color: #ddd; }
        .theme-space label { color: #bbb; }
        .theme-space .readout { background: #333; color: #0f0; }

        /* Lab Theme for Unit 2 */
        .theme-lab .canvas-area { background: #f0f3f5; border: 4px solid #bdc3c7; }
    </style>
</head>
<body>

<div id="app-container">
    <aside>
        <h1>AP Physics 1 Lab</h1>
        
        <div class="unit-header" onclick="toggleMenu('u1-menu')">Unit 1: Kinematics <span>▼</span></div>
        <div id="u1-menu" class="sub-menu open">
            <button class="nav-btn active" onclick="loadSim('1.1')">1.1 Position & Velocity</button>
            <button class="nav-btn" onclick="loadSim('1.2')">1.2 Acceleration (1D)</button>
            <button class="nav-btn" onclick="loadSim('1.3')">1.3 Projectile Motion</button>
        </div>

        <div class="unit-header" onclick="toggleMenu('u2-menu')">Unit 2: Dynamics <span>▼</span></div>
        <div id="u2-menu" class="sub-menu">
            <button class="nav-btn" onclick="loadSim('2.1')">2.1 Newton's 2nd Law</button>
            <button class="nav-btn" onclick="loadSim('2.2')">2.2 Inclined Planes</button>
            <button class="nav-btn" onclick="loadSim('2.3')">2.3 Connected Systems</button>
        </div>

        <div class="unit-header" onclick="toggleMenu('u3-menu')">Unit 3: Circ. Motion <span>▼</span></div>
        <div id="u3-menu" class="sub-menu">
            <button class="nav-btn" onclick="loadSim('3.1')">3.1 Uniform Circ. Motion</button>
            <button class="nav-btn" onclick="loadSim('3.2')">3.2 Gravitation & Orbits</button>
        </div>

<div class="unit-header" onclick="toggleMenu('u4-menu')">Unit 4: Energy <span>▼</span></div>
        <div id="u4-menu" class="sub-menu">
            <button class="nav-btn" onclick="loadSim('4.1')">4.1 Conservation of Energy</button>
        </div>

        <div class="unit-header" onclick="toggleMenu('u5-menu')">Unit 5: Momentum <span>▼</span></div>
        <div id="u5-menu" class="sub-menu">
            <button class="nav-btn" onclick="loadSim('5.1')">5.1 Elastic/Inelastic Collisions</button>
        </div>

        <div class="unit-header" onclick="toggleMenu('u6-menu')">Unit 6: SHM <span>▼</span></div>
        <div id="u6-menu" class="sub-menu">
            <button class="nav-btn" onclick="loadSim('6.1')">6.1 Spring Mass Systems</button>
        </div>

        <div class="unit-header" onclick="toggleMenu('u7-menu')">Unit 7: Torque <span>▼</span></div>
        <div id="u7-menu" class="sub-menu">
            <button class="nav-btn" onclick="loadSim('7.1')">7.1 Torque & Equilibrium</button>
        </div>
    </aside>

    <main id="main-view">
        <h2 id="sim-title" style="margin-top:0; color: var(--primary);">Welcome</h2>
        
        <div id="sim-desc" class="desc-box">
            Select a simulation from the menu to begin.
        </div>

        <div class="sim-container hidden" id="sim-interface">
            <div class="canvas-area">
                <canvas id="sim-canvas" width="700" height="450"></canvas>
            </div>
            
            <div id="sim-controls" class="controls"></div>
        </div>
    </main>
</div>

<script>
    // === GLOBAL ENGINE ===
    const canvas = document.getElementById('sim-canvas');
    const ctx = canvas.getContext('2d');
    let currentSim = null;
    let animId = null;
    
    // Sim State Object (Reset on every load)
    let state = {};

    function toggleMenu(id) {
        document.getElementById(id).classList.toggle('open');
    }

    function stopSim() {
        if(animId) cancelAnimationFrame(animId);
        animId = null;
    }

    // === SIMULATION LOADER ===
    function loadSim(id) {
        stopSim();
        currentSim = id;
        
        // UI Reset
        document.getElementById('sim-interface').classList.remove('hidden');
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active'); // Highlight button
        document.getElementById('main-view').className = ''; // Reset themes

        // Logic Switch
        switch(id) {
            case '1.1': setup_1_1(); break;
            case '1.2': setup_1_2(); break;
            case '1.3': setup_1_3(); break;
            case '2.1': setup_2_1(); break;
            case '2.2': setup_2_2(); break;
            case '2.3': setup_2_3(); break;
            case '3.1': setup_3_1(); break;
            case '3.2': setup_3_2(); break;
        }
    }

    // ===============================================
    // === UNIT 1: KINEMATICS (Clean, Vector Focus) ===
    // ===============================================

    // --- 1.1 Position & Velocity ---
    function setup_1_1() {
        document.getElementById('sim-title').innerText = "1.1 Position and Constant Velocity";
        document.getElementById('sim-desc').innerHTML = `
            <h3>Understanding Displacement</h3>
            <p>This simulation visualizes the relationship between position (<span class="var">x</span>) and constant velocity (<span class="var">v</span>). 
            Observe how the velocity vector (red arrow) dictates the rate of change of the position vector (blue arrow).
            The motion is 1-Dimensional.</p>`;
        
        // Controls
        document.getElementById('sim-controls').innerHTML = `
            <div class="control-group">
                <label>Velocity (<i class="var">v</i>): <span id="val-v">5</span> m/s</label>
                <input type="range" id="in-v" min="-10" max="10" value="5" oninput="state.v=parseFloat(this.value); updateReadout()">
            </div>
            <div class="control-group">
                <label>Start Pos (<i class="var">x<sub>0</sub></i>): <span id="val-x">0</span> m</label>
                <input type="range" id="in-x" min="-50" max="50" value="0" oninput="state.x=parseFloat(this.value); updateReadout(); draw_1_1()">
            </div>
            <button class="btn btn-green" onclick="state.running=!state.running; loop_1_1()">Start / Stop</button>
            <div class="readout">Time: <span id="out-t">0.0</span>s <br> Pos: <span id="out-x">0.0</span>m</div>
        `;

        // Init State
        state = { x: 0, v: 5, t: 0, running: false };
        draw_1_1();
    }

    function loop_1_1() {
        if(!state.running || currentSim !== '1.1') return;
        state.t += 0.02;
        state.x += state.v * 0.02;
        updateReadout();
        draw_1_1();
        animId = requestAnimationFrame(loop_1_1);
    }

    function draw_1_1() {
        ctx.clearRect(0,0,700,450);
        // Grid
        drawGrid(50);
        // Axis
        ctx.beginPath(); ctx.moveTo(0, 225); ctx.lineTo(700, 225); ctx.stroke();
        
        // Object
        let px = 350 + (state.x * 5); // Scale 5px = 1m
        drawCar(px, 225, state.v);

        // Position Vector
        drawVector(350, 225, px - 350, 0, "blue", "x");
    }

    // --- 1.3 Projectile Motion ---
    function setup_1_3() {
        document.getElementById('sim-title').innerText = "1.3 Projectile Motion";
        document.getElementById('sim-desc').innerHTML = `
            <h3>Independence of Motion</h3>
            <p>Projectiles move in two dimensions simultaneously. The horizontal motion (<span class="var">x</span>) is constant velocity, while the vertical motion (<span class="var">y</span>) is affected by gravity (<span class="var">g</span>). 
            Use this tool to separate components and visualize the trajectory.</p>`;
        
        document.getElementById('sim-controls').innerHTML = `
             <div class="control-group">
                <label>Initial V (<i class="var">v<sub>i</sub></i>): <span id="val-vi">25</span> m/s</label>
                <input type="range" id="in-vi" min="10" max="40" value="25" oninput="state.vi=parseFloat(this.value); reset_1_3()">
            </div>
            <div class="control-group">
                <label>Angle (<i class="var">&theta;</i>): <span id="val-th">45</span>&deg;</label>
                <input type="range" id="in-th" min="0" max="90" value="45" oninput="state.th=parseFloat(this.value); reset_1_3()">
            </div>
            <button class="btn btn-green" onclick="state.running=true; loop_1_3()">Launch</button>
            <button class="btn btn-red" onclick="reset_1_3()">Reset</button>
            <div class="readout">Range: <span id="out-r">0.0</span>m <br> Height: <span id="out-h">0.0</span>m</div>
        `;
        reset_1_3();
    }

    function reset_1_3() {
        state = { 
            vi: parseFloat(document.getElementById('in-vi')?.value || 25), 
            th: parseFloat(document.getElementById('in-th')?.value || 45),
            t: 0, x: 0, y: 0, running: false, trail: [] 
        };
        // Update labels
        document.getElementById('val-vi').innerText = state.vi;
        document.getElementById('val-th').innerText = state.th;
        draw_1_3();
    }

    function loop_1_3() {
        if(!state.running || currentSim !== '1.3') return;
        let dt = 0.05;
        state.t += dt;
        let rad = state.th * Math.PI/180;
        
        // Physics
        state.x = (state.vi * Math.cos(rad)) * state.t;
        state.y = (state.vi * Math.sin(rad) * state.t) - (0.5 * 9.8 * state.t**2);
        
        state.trail.push({x: state.x, y: state.y});

        if(state.y < 0) { state.y = 0; state.running = false; }
        
        // Data
        document.getElementById('out-r').innerText = state.x.toFixed(1);
        document.getElementById('out-h').innerText = Math.max(0, state.y).toFixed(1);

        draw_1_3();
        if(state.running) animId = requestAnimationFrame(loop_1_3);
    }

    function draw_1_3() {
        ctx.clearRect(0,0,700,450);
        // Ground
        ctx.fillStyle = "#ecf0f1"; ctx.fillRect(0, 400, 700, 50);
        
        // Trajectory
        ctx.beginPath(); ctx.strokeStyle = "#95a5a6"; ctx.setLineDash([5,5]);
        state.trail.forEach((p,i) => {
            let sx = 20 + p.x * 5; let sy = 400 - p.y * 5;
            if(i==0) ctx.moveTo(sx, sy); else ctx.lineTo(sx, sy);
        });
        ctx.stroke(); ctx.setLineDash([]);

        // Ball
        let sx = 20 + state.x * 5;
        let sy = 400 - state.y * 5;
        ctx.fillStyle = "#e74c3c"; ctx.beginPath(); ctx.arc(sx, sy, 6, 0, Math.PI*2); ctx.fill();

        // Component Vectors
        if(state.running || state.y > 0) {
            let vx = state.vi * Math.cos(state.th * Math.PI/180);
            let vy = state.vi * Math.sin(state.th * Math.PI/180) - (9.8 * state.t);
            drawVector(sx, sy, vx*2, 0, "blue"); // Vx
            drawVector(sx, sy, 0, -vy*2, "green"); // Vy (Note: negative y is up in canvas logic for vectors usually, but here sy is canvas coord)
        }
    }

    // ===============================================
    // === UNIT 2: DYNAMICS (Lab Bench Theme) ===
    // ===============================================

    function setup_2_2() {
        document.getElementById('main-view').classList.add('theme-lab'); // CSS class
        document.getElementById('sim-title').innerText = "2.2 Inclined Planes";
        document.getElementById('sim-desc').innerHTML = `
            <h3>Forces on a Slope</h3>
            <p>On an incline, gravity (<span class="var">F<sub>g</sub></span>) is resolved into perpendicular and parallel components. 
            Friction (<span class="var">F<sub>f</sub></span>) opposes motion. Adjust the coefficient of friction (<span class="var">&mu;</span>) and angle (<span class="var">&theta;</span>) to see if the block slides.</p>`;

        document.getElementById('sim-controls').innerHTML = `
            <div class="control-group">
                <label>Mass (<i class="var">m</i>): <span id="val-m">2</span> kg</label>
                <input type="range" id="in-m" min="1" max="10" value="2" oninput="state.m=parseFloat(this.value); draw_2_2()">
            </div>
            <div class="control-group">
                <label>Angle (<i class="var">&theta;</i>): <span id="val-a">30</span>&deg;</label>
                <input type="range" id="in-a" min="0" max="60" value="30" oninput="state.angle=parseFloat(this.value); draw_2_2()">
            </div>
            <div class="control-group">
                <label>Friction (<i class="var">&mu;</i>): <span id="val-mu">0.3</span></label>
                <input type="range" id="in-mu" min="0" max="1.0" step="0.1" value="0.3" oninput="state.mu=parseFloat(this.value); draw_2_2()">
            </div>
            <button class="btn btn-green" onclick="state.running=!state.running; loop_2_2()">Slide</button>
            <div class="readout">Net Force: <span id="out-f">0.0</span> N</div>
        `;
        
        state = { m: 2, angle: 30, mu: 0.3, x: 0, v: 0, running: false };
        draw_2_2();
    }

    function loop_2_2() {
        if(!state.running || currentSim !== '2.2') return;
        
        let g = 9.8;
        let rad = state.angle * Math.PI/180;
        let Fgx = state.m * g * Math.sin(rad);
        let Fgy = state.m * g * Math.cos(rad); // Normal force = Fgy
        let Ff = state.mu * Fgy;
        
        let Fnet = Fgx - Ff;
        if(Fnet < 0) Fnet = 0; // Static friction prevents moving up

        let a = Fnet / state.m;
        state.v += a * 0.02;
        state.x += state.v * 0.02;

        document.getElementById('out-f').innerText = Fnet.toFixed(2);
        
        if(state.x > 8) state.running = false; // End of ramp
        
        draw_2_2();
        animId = requestAnimationFrame(loop_2_2);
    }

    function draw_2_2() {
        // Lab Bench background
        ctx.fillStyle = "#f0f3f5"; ctx.fillRect(0,0,700,450);
        
        let rad = state.angle * Math.PI/180;
        let cx = 100, cy = 400;
        
        // Ramp
        ctx.fillStyle = "#bdc3c7"; 
        ctx.beginPath(); ctx.moveTo(cx, cy); 
        ctx.lineTo(cx + 500*Math.cos(rad), cy - 500*Math.sin(rad)); 
        ctx.lineTo(cx + 500*Math.cos(rad), cy); 
        ctx.fill();

        // Block Rotation Logic
        ctx.save();
        ctx.translate(cx, cy);
        ctx.rotate(-rad);
        
        let bx = state.x * 50 + 50; // px
        ctx.fillStyle = "#e67e22"; ctx.fillRect(bx, -40, 40, 40);
        
        // FBD
        let cenX = bx + 20; let cenY = -20;
        // Normal (Up relative to slope)
        drawVector(cenX, cenY, 0, -60, "blue"); 
        // Friction (Left relative to slope)
        if(state.mu > 0) drawVector(cenX, cenY, -40, 0, "red");
        
        ctx.restore();
        
        // Gravity (Always down in world space)
        // Need to project block center to world space
        let wx = cx + (bx+20)*Math.cos(rad) - (-20)*Math.sin(rad); // Simple approx
        // Actually: rotated x is bx+20, y is -20.
        let worldX = cx + (bx+20) * Math.cos(rad) - (-20) * Math.sin(rad); // Rotation matrix
        let worldY = cy + (bx+20) * Math.sin(-rad) + (-20) * Math.cos(-rad); // Note the -rad for canvas y flip? No, standard rot.
        // Simplified visual anchor:
        let visX = cx + (state.x*50 + 70)*Math.cos(rad);
        let visY = cy - (state.x*50 + 70)*Math.sin(rad);
        drawVector(visX, visY, 0, 60, "green"); // Gravity straight down
    }

    // ===============================================
    // === UNIT 3: CIRCULAR MOTION (Space Theme) ===
    // ===============================================

    function setup_3_2() {
        document.getElementById('main-view').classList.add('theme-space');
        document.getElementById('sim-title').innerText = "3.2 Universal Gravitation & Orbits";
        document.getElementById('sim-desc').innerHTML = `
            <h3>Orbit Simulation</h3>
            <p>The gravitational force (<span class="var">F<sub>g</sub></span>) provides the centripetal force required to keep a satellite in orbit. 
            If velocity (<span class="var">v</span>) is too high, the satellite escapes. If too low, it crashes.
            <br><i>Equation:</i> <span class="var">F<sub>g</sub> = Gm<sub>1</sub>m<sub>2</sub> / r<sup>2</sup></span></p>`;

        document.getElementById('sim-controls').innerHTML = `
             <div class="control-group">
                <label>Orbital Velocity (<span class="var">v</span>)</label>
                <input type="range" id="in-ov" min="0" max="10" step="0.1" value="4.5" oninput="reset_3_2()">
            </div>
             <div class="control-group">
                <label>Distance (<span class="var">r</span>)</label>
                <input type="range" id="in-or" min="50" max="200" value="120" oninput="reset_3_2()">
            </div>
            <button class="btn btn-green" onclick="state.running=!state.running; loop_3_2()">Play / Pause</button>
            <button class="btn btn-red" onclick="reset_3_2()">Reset</button>
        `;
        reset_3_2();
    }

    function reset_3_2() {
        let r = parseFloat(document.getElementById('in-or').value);
        let v = parseFloat(document.getElementById('in-ov').value);
        state = { 
            sunM: 1000, 
            planetX: r, planetY: 0, 
            vx: 0, vy: v, 
            trail: [], running: false 
        };
        draw_3_2();
    }

    function loop_3_2() {
        if(!state.running || currentSim !== '3.2') return;

        // Euler Integration for Orbits (Simple)
        let r2 = state.planetX**2 + state.planetY**2;
        let r = Math.sqrt(r2);
        let F = 5000 / r2; // G*M simplified to 5000 for visual scaling
        
        let angle = Math.atan2(state.planetY, state.planetX);
        let ax = -F * Math.cos(angle);
        let ay = -F * Math.sin(angle);

        state.vx += ax;
        state.vy += ay;
        state.planetX += state.vx;
        state.planetY += state.vy;

        state.trail.push({x: state.planetX, y: state.planetY});
        if(state.trail.length > 200) state.trail.shift();

        // Crash check
        if(r < 20) state.running = false; 

        draw_3_2();
        animId = requestAnimationFrame(loop_3_2);
    }

    function draw_3_2() {
        ctx.fillStyle = "#000000"; ctx.fillRect(0,0,700,450);
        
        let cx = 350, cy = 225; // Center of canvas
        
        // Star
        ctx.fillStyle = "#f1c40f"; 
        ctx.beginPath(); ctx.arc(cx, cy, 20, 0, Math.PI*2); ctx.fill();
        // Glow
        ctx.strokeStyle = "rgba(241, 196, 15, 0.2)"; ctx.lineWidth=10; ctx.stroke(); ctx.lineWidth=1;

        // Trail
        ctx.strokeStyle = "#3498db"; ctx.beginPath();
        state.trail.forEach((p, i) => {
            if(i==0) ctx.moveTo(cx + p.x, cy + p.y);
            else ctx.lineTo(cx + p.x, cy + p.y);
        });
        ctx.stroke();

        // Planet
        let px = cx + state.planetX;
        let py = cy + state.planetY;
        ctx.fillStyle = "#fff"; ctx.beginPath(); ctx.arc(px, py, 5, 0, Math.PI*2); ctx.fill();

        // Force Vector (Gravity)
        let angle = Math.atan2(state.planetY, state.planetX);
        let Flen = 30; // Visual length
        drawVector(px, py, -Flen*Math.cos(angle), -Flen*Math.sin(angle), "red");
        
        // Velocity Vector
        drawVector(px, py, state.vx*5, state.vy*5, "green");
    }

    // === UTILITY HELPERS ===
    
    // Updates the text numbers in the UI
    function updateReadout() {
        if(document.getElementById('out-t')) document.getElementById('out-t').innerText = state.t.toFixed(2);
        if(document.getElementById('out-x')) document.getElementById('out-x').innerText = state.x.toFixed(2);
        if(document.getElementById('val-v')) document.getElementById('val-v').innerText = state.v;
        if(document.getElementById('val-x')) document.getElementById('val-x').innerText = state.x;
    }

// ===============================================
    // === UNIT 1.2: ACCELERATION (Graph Focus) ===
    // ===============================================
    function setup_1_2() {
        document.getElementById('sim-title').innerText = "1.2 Accelerated Motion";
        document.getElementById('sim-desc').innerHTML = `
            <h3>Changing Velocity</h3>
            <p>When velocity changes, we have acceleration (<span class="var">a</span>). 
            Positive acceleration speeds up an object moving in the positive direction, while negative acceleration (deceleration) slows it down.
            Observe how the spacing between the "bread crumb" trail dots increases as speed increases.</p>`;

        document.getElementById('sim-controls').innerHTML = `
            <div class="control-group">
                <label>Initial Vel (<i class="var">v<sub>0</sub></i>): <span id="val-v0">0</span> m/s</label>
                <input type="range" id="in-v0" min="0" max="10" value="0" step="0.5" oninput="reset_1_2()">
            </div>
            <div class="control-group">
                <label>Accel (<i class="var">a</i>): <span id="val-a">1.0</span> m/s²</label>
                <input type="range" id="in-a" min="-2" max="2" value="1.0" step="0.1" oninput="reset_1_2()">
            </div>
            <button class="btn btn-green" onclick="state.running=!state.running; loop_1_2()">Start / Stop</button>
            <button class="btn btn-red" onclick="reset_1_2()">Reset</button>
            <div class="readout">Vel (<i class="var">v</i>): <span id="out-v">0.0</span> m/s <br> Pos (<i class="var">x</i>): <span id="out-x">0.0</span> m</div>
        `;
        reset_1_2();
    }

    function reset_1_2() {
        state = { 
            v0: parseFloat(document.getElementById('in-v0').value), 
            a: parseFloat(document.getElementById('in-a').value),
            x: 0, v: 0, t: 0, running: false, trail: [] 
        };
        state.v = state.v0;
        document.getElementById('val-v0').innerText = state.v0;
        document.getElementById('val-a').innerText = state.a;
        updateReadout_1_2();
        draw_1_2();
    }

    function loop_1_2() {
        if(!state.running || currentSim !== '1.2') return;
        let dt = 0.05;
        state.t += dt;
        
        // Kinematics: v = v0 + at
        state.v = state.v0 + (state.a * state.t);
        // x = x0 + v0t + 0.5at^2
        state.x = (state.v0 * state.t) + (0.5 * state.a * state.t * state.t);

        // Trail logic (drop a dot every 0.5 seconds)
        if (Math.floor(state.t / 0.5) > state.trail.length) {
            state.trail.push(state.x);
        }

        updateReadout_1_2();
        draw_1_2();
        
        // Stop if off screen
        if(state.x > 65 || state.x < -5) state.running = false;
        else animId = requestAnimationFrame(loop_1_2);
    }

    function updateReadout_1_2() {
        document.getElementById('out-v').innerText = state.v.toFixed(2);
        document.getElementById('out-x').innerText = state.x.toFixed(2);
    }

    function draw_1_2() {
        ctx.clearRect(0,0,700,450);
        drawGrid(50);
        
        // Ground line
        ctx.beginPath(); ctx.moveTo(0, 250); ctx.lineTo(700, 250); ctx.stroke();
        
        // Motion Map (Breadcrumbs)
        ctx.fillStyle = "rgba(46, 204, 113, 0.5)";
        state.trail.forEach(pos => {
            let px = 50 + pos * 10;
            ctx.beginPath(); ctx.arc(px, 250, 4, 0, Math.PI*2); ctx.fill();
        });

        // Car
        let cx = 50 + state.x * 10; // Scale 10px = 1m
        drawCar(cx, 250, state.v);
        
        // Acceleration Vector (Orange) above car
        if (Math.abs(state.a) > 0.1) {
            drawVector(cx, 200, state.a * 20, 0, "#e67e22");
            ctx.fillStyle = "#e67e22"; ctx.fillText("a", cx-5, 190);
        }
    }

    // ===============================================
    // === UNIT 2.1: NEWTON'S 2ND LAW (Lab Bench) ===
    // ===============================================
    function setup_2_1() {
        document.getElementById('main-view').classList.add('theme-lab');
        document.getElementById('sim-title').innerText = "2.1 Newton's Second Law";
        document.getElementById('sim-desc').innerHTML = `
            <h3>F = ma</h3>
            <p>Acceleration is directly proportional to Net Force (<span class="var">F<sub>net</sub></span>) and inversely proportional to Mass (<span class="var">m</span>).
            <br>In this frictionless environment, apply a force to see the resulting acceleration.</p>`;

        document.getElementById('sim-controls').innerHTML = `
            <div class="control-group">
                <label>Force (<i class="var">F</i>): <span id="val-f">10</span> N</label>
                <input type="range" id="in-f" min="-50" max="50" value="10" oninput="reset_2_1()">
            </div>
            <div class="control-group">
                <label>Mass (<i class="var">m</i>): <span id="val-m">5</span> kg</label>
                <input type="range" id="in-m" min="1" max="20" value="5" oninput="reset_2_1()">
            </div>
            <button class="btn btn-green" onclick="state.running=!state.running; loop_2_1()">Push</button>
            <button class="btn btn-red" onclick="reset_2_1()">Reset</button>
            <div class="readout">Accel (<i class="var">a</i>): <span id="out-a">2.00</span> m/s²</div>
        `;
        reset_2_1();
    }

    function reset_2_1() {
        state = { 
            F: parseFloat(document.getElementById('in-f').value), 
            m: parseFloat(document.getElementById('in-m').value),
            x: 0, v: 0, running: false 
        };
        state.a = state.F / state.m;
        
        document.getElementById('val-f').innerText = state.F;
        document.getElementById('val-m').innerText = state.m;
        document.getElementById('out-a').innerText = state.a.toFixed(2);
        draw_2_1();
    }

    function loop_2_1() {
        if(!state.running || currentSim !== '2.1') return;
        state.v += state.a * 0.05;
        state.x += state.v * 0.05;
        
        // Wall bounce
        if (state.x > 250 || state.x < -250) {
            state.v = -state.v * 0.5; // lose energy
            state.x = state.x > 0 ? 250 : -250;
            state.running = false;
        }

        draw_2_1();
        animId = requestAnimationFrame(loop_2_1);
    }

    function draw_2_1() {
        ctx.clearRect(0,0,700,450);
        ctx.fillStyle = "#f0f3f5"; ctx.fillRect(0,0,700,450); // Lab bg

        // Ice surface
        ctx.fillStyle = "#d1e8ff"; ctx.fillRect(50, 280, 600, 20);
        
        let cx = 350 + state.x;
        let cy = 280 - (state.m * 2); // Box size based on mass
        let size = state.m * 4; 
        if(size < 30) size = 30; // Min size

        // Block
        ctx.fillStyle = "#e74c3c"; ctx.fillRect(cx - size/2, 280 - size, size, size);
        ctx.strokeStyle = "#c0392b"; ctx.strokeRect(cx - size/2, 280 - size, size, size);
        
        // Text on block
        ctx.fillStyle = "white"; ctx.textAlign = "center"; 
        ctx.font = "bold 14px sans-serif"; ctx.fillText(state.m + "kg", cx, 280 - size/2 + 5);

        // Force Vector
        if (Math.abs(state.F) > 0) {
            drawVector(cx, 280 - size/2, state.F * 3, 0, "black");
            ctx.fillStyle = "black"; ctx.fillText("F", cx + state.F*3, 280 - size/2 - 10);
        }
    }

    // ===============================================
    // === UNIT 2.3: CONNECTED SYSTEMS (Atwood) ===
    // ===============================================
    function setup_2_3() {
        document.getElementById('main-view').classList.add('theme-lab');
        document.getElementById('sim-title').innerText = "2.3 Connected Systems (Atwood Machine)";
        document.getElementById('sim-desc').innerHTML = `
            <h3>System Acceleration</h3>
            <p>Two masses connected by a string over a pulley. The system accelerates based on the difference in mass.
            <br>Equation: <span class="var">a = g(m<sub>2</sub> - m<sub>1</sub>) / (m<sub>1</sub> + m<sub>2</sub>)</span></p>`;

        document.getElementById('sim-controls').innerHTML = `
            <div class="control-group">
                <label>Mass 1 (Left): <span id="val-m1">2</span> kg</label>
                <input type="range" id="in-m1" min="1" max="10" value="2" oninput="reset_2_3()">
            </div>
            <div class="control-group">
                <label>Mass 2 (Right): <span id="val-m2">4</span> kg</label>
                <input type="range" id="in-m2" min="1" max="10" value="4" oninput="reset_2_3()">
            </div>
            <button class="btn btn-green" onclick="state.running=!state.running; loop_2_3()">Release</button>
            <button class="btn btn-red" onclick="reset_2_3()">Reset</button>
            <div class="readout">Accel (<i class="var">a</i>): <span id="out-a">0.00</span> m/s²</div>
        `;
        reset_2_3();
    }

    function reset_2_3() {
        state = { 
            m1: parseFloat(document.getElementById('in-m1').value), 
            m2: parseFloat(document.getElementById('in-m2').value),
            pos: 0, v: 0, running: false 
        };
        // Calc acceleration
        let g = 9.8;
        state.a = g * (state.m2 - state.m1) / (state.m1 + state.m2);
        
        document.getElementById('val-m1').innerText = state.m1;
        document.getElementById('val-m2').innerText = state.m2;
        document.getElementById('out-a').innerText = Math.abs(state.a).toFixed(2);
        draw_2_3();
    }

    function loop_2_3() {
        if(!state.running || currentSim !== '2.3') return;
        state.v += state.a * 0.05;
        state.pos += state.v * 0.05;
        
        // Floor Limits
        if(state.pos > 150 || state.pos < -150) state.running = false;
        
        draw_2_3();
        animId = requestAnimationFrame(loop_2_3);
    }

    function draw_2_3() {
        ctx.clearRect(0,0,700,450);
        ctx.fillStyle = "#f0f3f5"; ctx.fillRect(0,0,700,450);

        // Pulley
        let cx = 350, cy = 50;
        ctx.beginPath(); ctx.arc(cx, cy, 30, 0, Math.PI*2); 
        ctx.fillStyle = "#333"; ctx.fill();
        
        // String
        ctx.strokeStyle = "black"; ctx.lineWidth = 2;
        ctx.beginPath();
        // Left String
        ctx.moveTo(cx - 30, cy); ctx.lineTo(cx - 30, cy + 150 - state.pos);
        // Right String
        ctx.moveTo(cx + 30, cy); ctx.lineTo(cx + 30, cy + 150 + state.pos);
        ctx.stroke();

        // Masses
        let y1 = cy + 150 - state.pos;
        let y2 = cy + 150 + state.pos;
        let s1 = 20 + state.m1 * 3;
        let s2 = 20 + state.m2 * 3;

        // Draw M1
        ctx.fillStyle = "#3498db"; ctx.fillRect(cx - 30 - s1/2, y1, s1, s1);
        ctx.fillStyle = "white"; ctx.textAlign = "center"; ctx.fillText("m1", cx - 30, y1+s1/2+5);

        // Draw M2
        ctx.fillStyle = "#e74c3c"; ctx.fillRect(cx + 30 - s2/2, y2, s2, s2);
        ctx.fillStyle = "white"; ctx.fillText("m2", cx + 30, y2+s2/2+5);
    }


    // ===============================================
    // === UNIT 3.1: CIRCULAR MOTION (Vector View) ===
    // ===============================================
    function setup_3_1() {
        document.getElementById('main-view').classList.add('theme-space');
        document.getElementById('sim-title').innerText = "3.1 Uniform Circular Motion";
        document.getElementById('sim-desc').innerHTML = `
            <h3>Velocity vs Acceleration</h3>
            <p>In Uniform Circular Motion (UCM), speed is constant, but velocity changes direction. 
            This requires a centripetal acceleration (<span class="var">a<sub>c</sub></span>) pointing toward the center.
            <br>Vectors: <span style="color:#2ecc71">Green = Velocity</span>, <span style="color:#f1c40f">Yellow = Acceleration</span>.</p>`;

        document.getElementById('sim-controls').innerHTML = `
            <div class="control-group">
                <label>Radius (<i class="var">r</i>): <span id="val-r">100</span> m</label>
                <input type="range" id="in-r" min="50" max="150" value="100" oninput="reset_3_1()">
            </div>
            <div class="control-group">
                <label>Velocity (<i class="var">v</i>): <span id="val-v">5</span> m/s</label>
                <input type="range" id="in-v" min="1" max="10" value="5" oninput="reset_3_1()">
            </div>
            <button class="btn btn-green" onclick="state.running=!state.running; loop_3_1()">Play / Pause</button>
            <div class="readout">Centripetal Accel (<i class="var">a<sub>c</sub></i>): <span id="out-ac">0.0</span> m/s²</div>
        `;
        reset_3_1();
    }

    function reset_3_1() {
        state = { 
            r: parseFloat(document.getElementById('in-r').value), 
            v: parseFloat(document.getElementById('in-v').value),
            angle: 0, running: false 
        };
        // ac = v^2 / r
        let ac = (state.v * state.v) / (state.r / 10); // scale factor fix
        document.getElementById('val-r').innerText = state.r;
        document.getElementById('val-v').innerText = state.v;
        document.getElementById('out-ac').innerText = (state.v**2 / (state.r/10)).toFixed(2);
        draw_3_1();
    }

    function loop_3_1() {
        if(!state.running || currentSim !== '3.1') return;
        
        // Angular velocity w = v / r
        let w = state.v / state.r; 
        state.angle += w * 5; // speed multiplier for visuals

        draw_3_1();
        animId = requestAnimationFrame(loop_3_1);
    }

    function draw_3_1() {
        ctx.fillStyle = "#000"; ctx.fillRect(0,0,700,450);
        let cx = 350, cy = 225;

        // Path
        ctx.strokeStyle = "#333"; ctx.lineWidth = 2; ctx.beginPath();
        ctx.arc(cx, cy, state.r, 0, Math.PI*2); ctx.stroke();

        // Object
        let ox = cx + state.r * Math.cos(state.angle);
        let oy = cy + state.r * Math.sin(state.angle);

        ctx.fillStyle = "#fff"; ctx.beginPath(); ctx.arc(ox, oy, 8, 0, Math.PI*2); ctx.fill();

        // Vectors
        // Velocity (Tangent)
        let vx = -Math.sin(state.angle) * state.v * 8;
        let vy = Math.cos(state.angle) * state.v * 8;
        drawVector(ox, oy, vx, vy, "#2ecc71"); // Green

        // Acceleration (Radial Inward)
        let ax = -Math.cos(state.angle) * 60;
        let ay = -Math.sin(state.angle) * 60;
        drawVector(ox, oy, ax, ay, "#f1c40f"); // Yellow
    }

    function missing(title) {
        document.getElementById('sim-title').innerText = title;
        document.getElementById('sim-desc').innerHTML = "<p>This simulation is queued for generation in the next update.</p>";
        document.getElementById('sim-controls').innerHTML = "<p style='color:#777; font-style:italic;'>Controls loading...</p>";
        ctx.clearRect(0,0,700,450);
        ctx.fillStyle = "#f4f6f7"; ctx.fillRect(0,0,700,450);
        ctx.fillStyle = "#333"; ctx.font = "20px Arial"; ctx.fillText("Pending Construction...", 250, 225);
    }

    // Helper: Draw Arrow
    function drawVector(x, y, dx, dy, color) {
        let head = 10;
        let angle = Math.atan2(dy, dx);
        ctx.strokeStyle = color; ctx.fillStyle = color; ctx.lineWidth = 2;
        ctx.beginPath(); ctx.moveTo(x, y); ctx.lineTo(x + dx, y + dy); ctx.stroke();
        ctx.beginPath(); 
        ctx.moveTo(x+dx, y+dy);
        ctx.lineTo(x+dx - head*Math.cos(angle-Math.PI/6), y+dy - head*Math.sin(angle-Math.PI/6));
        ctx.lineTo(x+dx - head*Math.cos(angle+Math.PI/6), y+dy - head*Math.sin(angle+Math.PI/6));
        ctx.fill();
        ctx.lineWidth = 1;
    }

    function drawCar(x, y, v) {
        ctx.fillStyle = "#34495e";
        ctx.fillRect(x-15, y-10, 30, 20); // Body
        ctx.fillStyle = "black";
        ctx.beginPath(); ctx.arc(x-10, y+10, 4, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(x+10, y+10, 4, 0, Math.PI*2); ctx.fill();
        // Velocity Arrow
        drawVector(x, y-15, v*3, 0, "red");
    }

    function drawGrid(step) {
        ctx.strokeStyle = "#e0e0e0";
        ctx.beginPath();
        for(let x=0; x<700; x+=step) { ctx.moveTo(x,0); ctx.lineTo(x,450); }
        for(let y=0; y<450; y+=step) { ctx.moveTo(0,y); ctx.lineTo(700,y); }
        ctx.stroke();
    }

    // Load Default
    loadSim('1.1');
// ===============================================
    // === UPDATE: SWITCH LOGIC FOR NEW UNITS ===
    // ===============================================
    // NOTE: We hook into the existing loadSim function by overriding the switch momentarily 
    // or you can manually update the switch in your code. 
    // Ideally, update your existing 'switch(id)' block to include these cases:
    /*
        case '4.1': setup_4_1(); break;
        case '5.1': setup_5_1(); break;
        case '6.1': setup_6_1(); break;
        case '7.1': setup_7_1(); break;
    */
    // Since I cannot edit your file directly, I will overwrite the loadSim function 
    // to include the old AND new units.
    
    // REPLACING THE PREVIOUS loadSim FUNCTION:
    function loadSim(id) {
        stopSim();
        currentSim = id;
        document.getElementById('sim-interface').classList.remove('hidden');
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        if(event && event.target) event.target.classList.add('active'); 
        document.getElementById('main-view').className = ''; 

        switch(id) {
            case '1.1': setup_1_1(); break;
            case '1.2': setup_1_2(); break;
            case '1.3': setup_1_3(); break;
            case '2.1': setup_2_1(); break;
            case '2.2': setup_2_2(); break;
            case '2.3': setup_2_3(); break;
            case '3.1': setup_3_1(); break;
            case '3.2': setup_3_2(); break;
            // NEW UNITS
            case '4.1': setup_4_1(); break;
            case '5.1': setup_5_1(); break;
            case '6.1': setup_6_1(); break;
            case '7.1': setup_7_1(); break;
        }
    }

    // ===============================================
    // === UNIT 4: ENERGY (Skate Park) ===
    // ===============================================
    function setup_4_1() {
        document.getElementById('sim-title').innerText = "4.1 Conservation of Energy";
        document.getElementById('sim-desc').innerHTML = `
            <h3>Energy Transformation</h3>
            <p>As the skater moves down the ramp, Potential Energy (<span class="var">U<sub>g</sub></span>) converts to Kinetic Energy (<span class="var">K</span>).
            In the absence of friction, the Total Mechanical Energy (<span class="var">E<sub>total</sub></span>) remains constant.</p>`;

        document.getElementById('sim-controls').innerHTML = `
            <div class="control-group">
                <label>Mass (<i class="var">m</i>): <span id="val-m">50</span> kg</label>
                <input type="range" id="in-m" min="10" max="100" value="50" oninput="reset_4_1()">
            </div>
            <div class="control-group">
                <label>Start Height (<i class="var">h</i>): <span id="val-h">5</span> m</label>
                <input type="range" id="in-h" min="1" max="8" value="5" oninput="reset_4_1()">
            </div>
            <button class="btn btn-green" onclick="state.running=!state.running; loop_4_1()">Play / Pause</button>
            <button class="btn btn-red" onclick="reset_4_1()">Reset</button>
        `;
        reset_4_1();
    }

    function reset_4_1() {
        state = { 
            m: parseFloat(document.getElementById('in-m').value), 
            hStart: parseFloat(document.getElementById('in-h').value),
            x: 0, running: false 
        };
        // Map x (0 to 700) to a track shape
        // Track: Parabola y = 0.003(x-350)^2
        document.getElementById('val-m').innerText = state.m;
        document.getElementById('val-h').innerText = state.hStart;
        
        // Start at left rim corresponding to height
        state.x = 350 - Math.sqrt(state.hStart / 0.003 * 10); // Inverse parabola
        draw_4_1();
    }

    function loop_4_1() {
        if(!state.running || currentSim !== '4.1') return;
        
        // Physics: Conservation of Energy
        // Total E = mgh_start
        // At any point: K = Total E - U
        // v = sqrt(2K/m)
        
        let g = 9.8;
        let scale = 40; // 40px = 1m
        let yBase = 400;
        
        // Track Geometry
        let dx = state.x - 350;
        let h = 0.003 * dx * dx / 10; // Height in meters
        let yPixels = yBase - h * scale;

        let Etot = state.m * g * state.hStart;
        let U = state.m * g * h;
        let K = Etot - U;
        
        if(K < 0) K = 0; // Floating point error catch
        let v = Math.sqrt(2 * K / state.m);

        // Direction logic
        if (!state.dir) state.dir = 1;
        
        // Move
        let slope = 0.006 * (state.x - 350); // dy/dx
        let angle = Math.atan(slope);
        let vx = v * Math.cos(angle);
        
        // Bounds check
        if (h > state.hStart && state.x > 350 && state.dir === 1) state.dir = -1;
        if (h > state.hStart && state.x < 350 && state.dir === -1) state.dir = 1;

        state.x += vx * state.dir * 0.2; // Time step factor
        
        state.K = K; state.U = U; state.Etot = Etot; // Store for draw
        draw_4_1();
        animId = requestAnimationFrame(loop_4_1);
    }

    function draw_4_1() {
        ctx.clearRect(0,0,700,450);
        
        // Draw Track
        ctx.beginPath();
        ctx.strokeStyle = "#555"; ctx.lineWidth = 5;
        for(let i=0; i<=700; i+=10) {
            let h = 0.003 * (i-350)**2 / 10;
            let y = 400 - h * 40;
            if(i===0) ctx.moveTo(i,y); else ctx.lineTo(i,y);
        }
        ctx.stroke();

        // Skater
        let h = 0.003 * (state.x-350)**2 / 10;
        let y = 400 - h * 40;
        ctx.fillStyle = "#e67e22"; 
        ctx.beginPath(); ctx.arc(state.x, y-10, 10, 0, Math.PI*2); ctx.fill();

        // --- BAR CHART ---
        // Setup
        let bx = 550, by = 150;
        let maxH = 100;
        let total = (state.Etot) ? state.Etot : state.m * 9.8 * state.hStart; // Fallback if not running
        
        // K (Green)
        let kH = (state.K / total) * maxH || 0;
        ctx.fillStyle = "#2ecc71"; ctx.fillRect(bx, by - kH, 30, kH);
        ctx.fillStyle = "#333"; ctx.fillText("K", bx+10, by+15);

        // U (Blue)
        let uH = (state.U / total) * maxH || (state.hStart > 0 ? maxH : 0); // Default full if reset
        ctx.fillStyle = "#3498db"; ctx.fillRect(bx+40, by - uH, 30, uH);
        ctx.fillText("U", bx+50, by+15);
        
        // Total (Yellow)
        ctx.fillStyle = "#f1c40f"; ctx.fillRect(bx+80, by - maxH, 30, maxH);
        ctx.fillText("Etot", bx+80, by+15);
    }

    // ===============================================
    // === UNIT 5: MOMENTUM (Collisions) ===
    // ===============================================
    function setup_5_1() {
        document.getElementById('sim-title').innerText = "5.1 Momentum & Collisions";
        document.getElementById('sim-desc').innerHTML = `
            <h3>Conservation of Momentum</h3>
            <p>Momentum (<span class="var">p = mv</span>) is always conserved in collisions.
            <br><b>Elastic:</b> Objects bounce, Kinetic Energy conserved.
            <br><b>Inelastic:</b> Objects stick, Kinetic Energy lost to heat.</p>`;

        document.getElementById('sim-controls').innerHTML = `
            <div class="control-group">
                <label>Mass 1 (Red): <span id="v-m1">2</span> kg</label>
                <input type="range" id="in-m1" min="1" max="5" value="2" oninput="reset_5_1()">
            </div>
            <div class="control-group">
                <label>Mass 2 (Blue): <span id="v-m2">2</span> kg</label>
                <input type="range" id="in-m2" min="1" max="5" value="2" oninput="reset_5_1()">
            </div>
            <div class="control-group">
                <label>Elasticity: <span id="v-e">Elastic (1.0)</span></label>
                <input type="range" id="in-e" min="0" max="1" step="1" value="1" oninput="reset_5_1()">
            </div>
            <button class="btn btn-green" onclick="state.running=!state.running; loop_5_1()">Collide</button>
            <button class="btn btn-red" onclick="reset_5_1()">Reset</button>
        `;
        reset_5_1();
    }

    function reset_5_1() {
        state = {
            m1: parseFloat(document.getElementById('in-m1').value),
            m2: parseFloat(document.getElementById('in-m2').value),
            e: parseFloat(document.getElementById('in-e').value), // 1 = elastic, 0 = inelastic
            x1: 100, v1: 5,
            x2: 500, v2: -2,
            running: false
        };
        
        document.getElementById('v-m1').innerText = state.m1;
        document.getElementById('v-m2').innerText = state.m2;
        document.getElementById('v-e').innerText = state.e === 1 ? "Elastic (Bouncy)" : "Inelastic (Sticky)";
        
        draw_5_1();
    }

    function loop_5_1() {
        if(!state.running || currentSim !== '5.1') return;

        state.x1 += state.v1;
        state.x2 += state.v2;

        // Collision Detect
        let s1 = state.m1 * 15; // Size proportional to mass
        let s2 = state.m2 * 15;
        
        if (state.x1 + s1 >= state.x2) {
            // Physics 1D Collision Eq
            let v1i = state.v1;
            let v2i = state.v2;
            let m1 = state.m1;
            let m2 = state.m2;

            if (state.e === 0) {
                // Perfectly Inelastic (Stick)
                let vf = (m1*v1i + m2*v2i) / (m1 + m2);
                state.v1 = vf; 
                state.v2 = vf;
            } else {
                // Elastic
                state.v1 = ((m1-m2)*v1i + 2*m2*v2i) / (m1+m2);
                state.v2 = ((m2-m1)*v2i + 2*m1*v1i) / (m1+m2);
            }
            
            // Separate slightly to prevent sticky-bug
            state.x1 = state.x2 - s1 - 1; 
        }

        draw_5_1();
        animId = requestAnimationFrame(loop_5_1);
    }

    function draw_5_1() {
        ctx.clearRect(0,0,700,450);
        // Track
        ctx.fillStyle = "#ddd"; ctx.fillRect(0, 200, 700, 10);
        
        let s1 = state.m1 * 15;
        let s2 = state.m2 * 15;

        // Cart 1
        ctx.fillStyle = "#e74c3c"; ctx.fillRect(state.x1, 200 - s1, s1, s1);
        ctx.fillStyle = "white"; ctx.fillText(state.v1.toFixed(1) + " m/s", state.x1, 190 - s1);

        // Cart 2
        ctx.fillStyle = "#3498db"; ctx.fillRect(state.x2, 200 - s2, s2, s2);
        ctx.fillStyle = "black"; ctx.fillText(state.v2.toFixed(1) + " m/s", state.x2, 190 - s2);
    }

    // ===============================================
    // === UNIT 6: SHM (Springs) ===
    // ===============================================
    function setup_6_1() {
        document.getElementById('sim-title').innerText = "6.1 Simple Harmonic Motion";
        document.getElementById('sim-desc').innerHTML = `
            <h3>Hooke's Law</h3>
            <p>Restoring Force: <span class="var">F<sub>s</sub> = -kx</span>.
            <br>Period: <span class="var">T = 2&pi;&radic;(m/k)</span>.
            <br>Observe the graph of Position vs. Time.</p>`;

        document.getElementById('sim-controls').innerHTML = `
            <div class="control-group">
                <label>Mass (<i class="var">m</i>): <span id="v-m">1</span> kg</label>
                <input type="range" id="in-m" min="0.5" max="3" step="0.5" value="1" oninput="reset_6_1()">
            </div>
            <div class="control-group">
                <label>Spring Constant (<i class="var">k</i>): <span id="v-k">10</span> N/m</label>
                <input type="range" id="in-k" min="5" max="30" value="10" oninput="reset_6_1()">
            </div>
            <button class="btn btn-green" onclick="state.running=!state.running; loop_6_1()">Play / Pause</button>
            <button class="btn btn-red" onclick="reset_6_1()">Reset</button>
            <div class="readout">Period (<i class="var">T</i>): <span id="out-t">0.0</span>s</div>
        `;
        reset_6_1();
    }

    function reset_6_1() {
        state = {
            m: parseFloat(document.getElementById('in-m').value),
            k: parseFloat(document.getElementById('in-k').value),
            t: 0, 
            amp: 100, // Pixels
            graph: [],
            running: false
        };
        document.getElementById('v-m').innerText = state.m;
        document.getElementById('v-k').innerText = state.k;
        let T = 2 * Math.PI * Math.sqrt(state.m / state.k);
        document.getElementById('out-t').innerText = T.toFixed(2);
        draw_6_1();
    }

    function loop_6_1() {
        if(!state.running || currentSim !== '6.1') return;
        state.t += 0.05;
        let w = Math.sqrt(state.k / state.m);
        let x = state.amp * Math.cos(w * state.t);
        
        state.x = x;
        state.graph.push(x);
        if(state.graph.length > 300) state.graph.shift();
        
        draw_6_1();
        animId = requestAnimationFrame(loop_6_1);
    }

    function draw_6_1() {
        ctx.clearRect(0,0,700,450);
        
        let wallX = 50;
        let eqX = 350;
        let blockX = eqX + (state.running ? state.x : state.amp);
        
        // Wall
        ctx.fillStyle = "#7f8c8d"; ctx.fillRect(wallX, 100, 20, 100);
        
        // Floor
        ctx.beginPath(); ctx.moveTo(wallX, 200); ctx.lineTo(700, 200); ctx.stroke();
        
        // Spring
        ctx.beginPath(); ctx.strokeStyle = "#333";
        let coils = 20;
        let springW = blockX - (wallX + 20);
        let coilW = springW / coils;
        ctx.moveTo(wallX+20, 150);
        for(let i=0; i<coils; i++) {
            ctx.lineTo(wallX+20 + coilW*(i+0.5), 150 + (i%2==0 ? 10 : -10));
        }
        ctx.lineTo(blockX, 150);
        ctx.stroke();

        // Block
        ctx.fillStyle = "#3498db"; ctx.fillRect(blockX, 130, 40, 40);

        // Equilibrium Line
        ctx.strokeStyle = "green"; ctx.setLineDash([5,5]);
        ctx.beginPath(); ctx.moveTo(eqX+20, 100); ctx.lineTo(eqX+20, 250); ctx.stroke();
        ctx.setLineDash([]);
        ctx.fillStyle = "green"; ctx.fillText("x=0", eqX+10, 265);

        // Graph Overlay
        ctx.fillStyle = "#fafafa"; ctx.fillRect(50, 300, 600, 120);
        ctx.strokeStyle = "#bdc3c7"; ctx.strokeRect(50, 300, 600, 120);
        
        ctx.beginPath(); ctx.strokeStyle = "red";
        state.graph.forEach((val, i) => {
            let gx = 650 - (state.graph.length - i) * 2;
            let gy = 360 - (val / 100) * 50; // Scale
            if(i==0) ctx.moveTo(gx, gy); else ctx.lineTo(gx, gy);
        });
        ctx.stroke();
        ctx.fillStyle = "#333"; ctx.fillText("Position vs Time", 60, 320);
    }

    // ===============================================
    // === UNIT 7: TORQUE (Seesaw) ===
    // ===============================================
    function setup_7_1() {
        document.getElementById('sim-title').innerText = "7.1 Torque & Equilibrium";
        document.getElementById('sim-desc').innerHTML = `
            <h3>Rotational Equilibrium</h3>
            <p>Torque (<span class="var">&tau; = rFsin&theta;</span>) causes rotation. 
            For the beam to balance, the net torque must be zero. 
            <br><span class="var">&tau;<sub>net</sub> = &tau;<sub>ccw</sub> - &tau;<sub>cw</sub> = 0</span></p>`;

        document.getElementById('sim-controls').innerHTML = `
            <div class="control-group">
                <label>Mass 1 (Left): <span id="v-m1">10</span> kg</label>
                <input type="range" id="in-m1" min="5" max="20" value="10" oninput="update_7_1()">
            </div>
            <div class="control-group">
                <label>Position 1 (<i class="var">r<sub>1</sub></i>): <span id="v-r1">2.0</span> m</label>
                <input type="range" id="in-r1" min="0.5" max="3.0" step="0.5" value="2.0" oninput="update_7_1()">
            </div>
            <div class="control-group">
                <label>Mass 2 (Right): <span id="v-m2">10</span> kg</label>
                <input type="range" id="in-m2" min="5" max="20" value="10" oninput="update_7_1()">
            </div>
            <div class="control-group">
                <label>Position 2 (<i class="var">r<sub>2</sub></i>): <span id="v-r2">2.0</span> m</label>
                <input type="range" id="in-r2" min="0.5" max="3.0" step="0.5" value="2.0" oninput="update_7_1()">
            </div>
            <div class="readout">Net Torque: <span id="out-tau">0.0</span> N&middot;m</div>
        `;
        update_7_1();
    }

    function update_7_1() {
        state = {
            m1: parseFloat(document.getElementById('in-m1').value),
            r1: parseFloat(document.getElementById('in-r1').value),
            m2: parseFloat(document.getElementById('in-m2').value),
            r2: parseFloat(document.getElementById('in-r2').value),
        };
        document.getElementById('v-m1').innerText = state.m1;
        document.getElementById('v-r1').innerText = state.r1;
        document.getElementById('v-m2').innerText = state.m2;
        document.getElementById('v-r2').innerText = state.r2;

        let tau1 = state.m1 * 9.8 * state.r1; // CCW (+)
        let tau2 = state.m2 * 9.8 * state.r2; // CW (-)
        state.net = tau1 - tau2;
        
        document.getElementById('out-tau').innerText = state.net.toFixed(1);
        
        // Calculate Tilt
        state.angle = 0;
        if (Math.abs(state.net) > 5) {
            state.angle = state.net > 0 ? -20 : 20; // Tilt left or right
        }
        draw_7_1();
    }

    function draw_7_1() {
        ctx.clearRect(0,0,700,450);
        
        let cx = 350, cy = 300;
        
        // Fulcrum
        ctx.fillStyle = "#7f8c8d";
        ctx.beginPath(); ctx.moveTo(cx, cy); ctx.lineTo(cx-20, cy+40); ctx.lineTo(cx+20, cy+40); ctx.fill();

        // Beam Rotation
        ctx.save();
        ctx.translate(cx, cy);
        let rad = state.angle * Math.PI / 180;
        ctx.rotate(rad);

        // Beam
        ctx.fillStyle = "#8e44ad"; ctx.fillRect(-250, -5, 500, 10);
        
        // Mass 1 (Left)
        let x1 = -state.r1 * 80; // Scale
        let s1 = state.m1 * 3;
        ctx.fillStyle = "#e74c3c"; ctx.fillRect(x1 - s1/2, -5 - s1, s1, s1);
        ctx.fillStyle = "white"; ctx.fillText(state.m1, x1-5, -10);

        // Mass 2 (Right)
        let x2 = state.r2 * 80;
        let s2 = state.m2 * 3;
        ctx.fillStyle = "#3498db"; ctx.fillRect(x2 - s2/2, -5 - s2, s2, s2);
        ctx.fillStyle = "white"; ctx.fillText(state.m2, x2-5, -10);

        ctx.restore();
    }
</script>

</body>
</html>
